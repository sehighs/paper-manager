<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡çŒ®ç®¡ç†å™¨ â€“ ä¼˜åŒ–ç‰ˆ v4.2</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- æ ¸å¿ƒåº“ -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- è‡ªå®šä¹‰æ ·å¼ -->
  <style>
    /* ---- é€šç”¨ Tag èƒ¶å›Š ---- */
    .chip{
      display:inline-block;margin:2px;padding:2px 8px;
      border-radius:9999px;font-size:12px;line-height:1;
      white-space:nowrap;user-select:none;cursor:pointer;
      background:#e5e7eb;color:#111827;transition:all .15s;
    }
    .chip-selected{background:#3b82f6!important;color:#fff!important;}
    .chip-author  {background:#bbf7d0;}   /* green-200 */
    .chip-imp     {background:#fecaca;}   /* red-200 */
    .chip-read    {background:#bfdbfe;}   /* sky-200 */
    .assoc-selected{background:#dbeafe!important;}

    /* ---- Tag å†…è”ç¼–è¾‘ UI ---- */
    .tag-wrap{position:relative;display:inline-block;margin:0 4px 4px 0;}

    .tag-btn{
      position:absolute;top:-6px;right:-6px;
      width:12px;height:12px;border-radius:9999px;
      display:flex;align-items:center;justify-content:center;
      font-size:8px;border:1px solid #d1d5db; /* gray-300 */
      background:#fff;cursor:pointer;transition:background .15s;
      line-height:1;
    }
    .tag-btn:hover{background:#f3f4f6;}       /* gray-100 */
    .tag-btn.del:hover{background:#fecaca;}    /* red-200 */
    .tag-btn.ren:hover{background:#bfdbfe;}    /* blue-200 */
    .tag-btn.del{right:0px;}                 /* â˜… æ–°å¢ */
    .tag-btn.ren{right:14px;}
  </style>
</head>

<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">
  <h1 class="text-2xl font-bold mb-4">ğŸ“š æœ¬åœ°æ–‡çŒ®ä¸ç¬”è®°ç®¡ç†å™¨</h1>

  <!-- ===== æ–‡çŒ®åŒº ===== -->
  <section class="w-full max-w-6xl mb-6 bg-white p-4 rounded-xl shadow">
    <div class="flex flex-col lg:flex-row gap-4">
      <!-- å·¦åˆ—ï¼šå½•å…¥+åˆ—è¡¨ -->
      <div class="flex-1">
        <!-- â€”â€” å½•å…¥æ  â€”â€” -->
        <div class="flex flex-wrap gap-2 mb-3 w-full items-center">
          <!-- æœç´¢åŒºåŸŸ + ä¸¤ç§æ¨¡å¼æŒ‰é’® -->
          <div class="flex gap-1 flex-1">
            <input id="search" placeholder="ğŸ” æœç´¢æ ‡é¢˜ / Tag / ä½œè€…" class="flex-1 border rounded p-2" list="search-suggestions" />
            <button id="search-current" class="px-3 py-2 bg-blue-600 text-white rounded whitespace-nowrap">å±€éƒ¨æœç´¢</button>
            <button id="search-global" class="px-3 py-2 bg-emerald-600 text-white rounded whitespace-nowrap">å…¨å±€æœç´¢</button>
            
            <datalist id="search-suggestions"></datalist>
          </div>
          <input id="lit-title" placeholder="æ ‡é¢˜(å¯ç•™ç©º)" class="flex-1 border rounded p-2" />
          <input id="lit-path" placeholder="./paper.pdf æˆ–é“¾æ¥" class="flex-1 border rounded p-2" />
          <input id="lit-folders" placeholder="æ”¶è—å¤¹,é€—å·" list="folder-list" class="flex-1 border rounded p-2" />
          <input id="lit-author" placeholder="ä½œè€…/å›¢ç»„" list="author-list" class="flex-1 border rounded p-2" />
          <select id="lit-importance" class="border rounded p-2">
            <option value="">é‡è¦ç¨‹åº¦</option><option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
          <select id="lit-read" class="border rounded p-2">
            <option value="">é˜…è¯»æƒ…å†µ</option><option>æœªè¯»</option><option>åªæµ…è¯»</option><option>å·²è¯»</option><option>å·²ç²¾è¯»</option>
          </select>
          <button id="add-lit" class="px-3 py-2 bg-blue-600 text-white rounded">æ·»åŠ </button>
          <button id="open-drop" class="px-3 py-2 bg-purple-600 text-white rounded">æ‹–æ‹½/æ‰¹é‡</button>
          <button id="clear-lit-filter" class="px-2 py-1 bg-gray-300 rounded">æ¸…é™¤è¿‡æ»¤</button>
        </div>

        <!-- â€”â€” ä¸‰ç±»ç­›é€‰æŒ‰é’®ï¼ˆå½©è‰² Chipsï¼‰ â€”â€” -->
        <div id="search-tags" class="space-y-2 mb-4"></div>

        <!-- â€”â€” æ–‡çŒ®åˆ—è¡¨ â€”â€” -->
        <ul id="lit-list" class="grid gap-2 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3"></ul>
        <div id="pagination" class="flex justify-center items-center gap-4 mt-4"></div>
      </div>

      <!-- å³åˆ—ï¼šè¿‡æ»¤é¢æ¿ï¼ˆç®€åŒ–ï¼‰ -->
      <aside class="w-full lg:w-56 bg-gray-50 p-3 rounded-xl text-sm space-y-2 h-fit">
        <h3 class="font-semibold">
          å…¨éƒ¨ Tag (å¤šé€‰)
          <button id="edit-tags"
                  class="ml-2 text-xs text-blue-600 hover:underline"
                  title="é‡å‘½å / åˆ é™¤ Tag">âœ</button>
        </h3>
        <div id="tag-list" class="flex flex-wrap gap-1"></div>
        <hr class="my-2" />
        <div class="flex items-center gap-2"><label>æ¯é¡µ</label><input id="page-size" type="number" min="1" class="w-16 border rounded p-1 text-center" /></div>
        <div>
          <div class="flex items-center gap-1 mt-1"><span>æ”¶è—å¤¹</span> 
          <button id="rename-folder" class="text-xs text-blue-600 hover:underline" title="é‡å‘½å">âœ</button>
          <button id="add-folder" class="ml-auto text-xs text-green-600 hover:underline" hover:underline" title="æ–°å»º">â•</button>
          <button id="delete-folder" class="ml-auto text-xs text-red-600  hover:underline" title="åˆ é™¤">ğŸ—‘</button></div>
          <select id="folder-filter" class="border rounded p-1 w-full"></select>
          <div class="mt-3 flex flex-col gap-2">            <!-- â† åªåŠ  mt-3 -->
            <button id="export-data"
                    class="w-full px-3 py-2 bg-amber-500 text-white rounded">
                             ä¸‹è½½æ•°æ®
            </button>

            <label class="cursor-pointer w-full px-3 py-2 bg-amber-600 text-white rounded text-center">
                                    å¯¼å…¥æ•°æ®
              <input type="file" id="import-data" accept=".json" class="hidden">
            </label>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- ===== ç¬”è®°åŒº (ä¿ç•™åŸåŠŸèƒ½) ===== -->
  <section class="w-full max-w-6xl mb-6 bg-white p-4 rounded-xl shadow">
    <h2 class="text-xl font-semibold mb-2">æ·»åŠ ç¬”è®°</h2>
    <input id="note-title" class="w-full border rounded p-2 mb-2" placeholder="ç¬”è®°æ ‡é¢˜" />
    <textarea id="note-md" rows="6" class="w-full border rounded p-2 mb-2" placeholder="Markdown..."></textarea>
    <!-- æ‰¹é‡æ–‡ä»¶å¤¹ & å•æ–‡ä»¶è·¯å¾„ åŒå…¥å£ -->
    <div class="flex flex-wrap items-center gap-3 mb-2">
      <!-- ğŸ“ æ‰¹é‡å½•å…¥ï¼šå¯ç›´æ¥é€‰æ–‡ä»¶å¤¹ -->
      <label class="cursor-pointer px-3 py-1 bg-gray-200 rounded">
        ğŸ“ æ‰¹é‡å½•å…¥ (é€‰æ–‡ä»¶å¤¹)
        <input type="file"
               id="note-folder"
               class="hidden"
               webkitdirectory
               directory
               multiple>
      </label>

      <!-- âœï¸ æ‰‹åŠ¨è¾“å…¥å•ä¸ª PDF è·¯å¾„ -->
      <input id="note-path-manual"
             class="border rounded p-1 flex-1"
             placeholder="æ‰‹åŠ¨è¾“å…¥ PDF ç›¸å¯¹/ç»å¯¹è·¯å¾„ï¼Œå¦‚ ./ç¬”è®°/abc.pdf">
    </div>

    <!-- å…³è”æŒ‰é’®åŒº -->
    <div class="flex items-center gap-3 mb-2">
      <button id="add-note" class="px-3 py-2 bg-green-600 text-white rounded">ä¿å­˜ç¬”è®°</button>
      <button id="start-assoc"  class="px-3 py-2 bg-blue-500  text-white rounded">â• å…³è”æ–‡çŒ®</button>
      <button id="finish-assoc" class="px-3 py-2 bg-green-600 text-white rounded hidden">âœ… å®Œæˆå…³è” (Enter)</button>
    </div>

    
    <ul id="note-list" class="list-disc pl-5 space-y-1 mt-4"></ul>
  </section>

  <section id="view" class="w-full max-w-6xl bg-white p-4 rounded-xl shadow hidden"></section>

  <!-- ===== æ‹–æ‹½æ¨¡æ€ ===== -->
  <div id="drop-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-xl w-[90%] max-w-lg relative">
      <button id="close-modal" class="absolute top-2 right-2">âœ–</button>
      <h3 class="text-lg font-semibold mb-2">æ‹–æ‹½æ–‡ä»¶æˆ–é€‰æ‹©æ–‡ä»¶å¤¹</h3>
      <div id="drop-zone" class="flex items-center justify-center border-4 border-dashed border-gray-400 rounded-lg h-40 mb-4"><span class="text-gray-500 select-none">æ‹–æ–‡ä»¶åˆ°æ­¤</span></div>
      <button id="choose-folder" class="px-3 py-2 bg-blue-600 text-white rounded">é€‰æ‹©æ–‡ä»¶å¤¹</button>
      <input id="folder-input" type="file" webkitdirectory multiple class="hidden" />
    </div>
  </div>

  <!-- ===== ç®¡ç†æ¨¡æ€ ===== -->
  <div id="manage-modal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-xl w-[90%] max-w-lg relative">
      <button id="close-manage-modal" class="absolute top-2 right-2">âœ–</button>
      <h3 id="manage-title" class="text-lg font-semibold mb-4">ç®¡ç†æ–‡çŒ®</h3>
      <div class="space-y-3">
        <div>
          <h4 class="font-medium mb-1">æ”¶è—å¤¹</h4>
          <div id="manage-folders" class="flex flex-wrap gap-2"></div>
          <div class="mt-2 flex gap-2">
            <input id="new-folder-input" list="folder-suggestions" autocomplete="off" class="border rounded px-2 flex-1" placeholder="è¾“å…¥æ”¶è—å¤¹å/å¯æ–°å¢">
            <button id="new-folder-btn" class="px-3 bg-withe-600 text-white rounded">â•</button>
        </div>
        <datalist id="folder-suggestions"></datalist>
        <div>
          <h4 class="font-medium mb-1">ä½œè€…/å›¢ç»„</h4>
          <input id="manage-author" class="w-full border rounded p-1" list="author-list" />
        </div>
        <div class="flex gap-4">
          <div class="flex-1">
            <h4 class="font-medium mb-1">é‡è¦ç¨‹åº¦</h4>
            <select id="manage-importance" class="border rounded p-1 w-full"><option value="">æœªè®¾ç½®</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select>
          </div>
          <div class="flex-1">
            <h4 class="font-medium mb-1">é˜…è¯»æƒ…å†µ</h4>
            <select id="manage-read" class="border rounded p-1 w-full"><option value="">æœªè®¾ç½®</option><option value="æœªè¯»">æœªè¯»</option><option value="åªæµ…è¯»">åªæµ…è¯»</option><option value="å·²è¯»">å·²è¯»</option><option value="å·²ç²¾è¯»">å·²ç²¾è¯»</option></select>
          </div>
        </div>
        <div>
          <h4 class="font-medium mb-1 flex items-center gap-2">Tag <span class="text-xs text-gray-400">(Tab / Enter / å¤±ç„¦ç¡®è®¤)</span></h4>
          <div id="manage-tags-box" class="flex flex-wrap gap-1"></div>
          <input id="manage-tag-input" class="w-full border rounded p-1 mt-1" placeholder="è¾“å…¥æˆ–é€‰æ‹© Tag" list="tag-list-dl" />
          <datalist id="tag-list-dl"></datalist>
        </div>
        <div class="text-right pt-2"><button id="save-manage" class="px-4 py-2 bg-green-600 text-white rounded">ä¿å­˜</button></div>
      </div>
    </div>
  </div>

  <!-- ===== datalists ===== -->
  <datalist id="folder-list"></datalist>
  <datalist id="author-list"></datalist>

<script>
/*************************
 * æ•°æ®ä¸å·¥å…·å‡½æ•°
 *************************/
const KEY = 'bibData';
const DEF = { literature: [], notes: [], folders: ['é»˜è®¤'] };
let data = JSON.parse(localStorage.getItem(KEY) || JSON.stringify(DEF));
const $ = (s) => document.querySelector(s);
const gid = () => Date.now() + Math.random().toString(36).slice(2, 8);
const save = () => localStorage.setItem(KEY, JSON.stringify(data));
const uniq = (a) => [...new Set(a)];
const setSel = (sel, arr, val) => { if(!sel) return; sel.innerHTML = ''; arr.forEach(v => sel.add(new Option(v, v))); sel.value = val; };

/*************************
 * å…¨å±€çŠ¶æ€
 *************************/
let page = 1,
    ps = parseInt(localStorage.getItem('ps')) || 9,
    curFolder = 'å…¨éƒ¨',
    searchTxt = '',
    tagFilters = [],      // å¤šé€‰ Tag
    authorFilter = 'å…¨éƒ¨',
    importanceFilter = 'å…¨éƒ¨',
    readFilter = 'å…¨éƒ¨';
let editingId = null;              // ç¬”è®°å½“å‰æ˜¯å¦å¤„åœ¨â€œç¼–è¾‘æ¨¡å¼â€
let tagEditMode = false;      // æ˜¯å¦å¤„äºâ€œTag ç¼–è¾‘â€æ¨¡å¼
/* â€”â€” å…³è”æ¨¡å¼ â€”â€” */
let assocMode = false;     // æ­£åœ¨å…³è”ï¼Ÿ
let assocSel  = [];        // å·²é€‰æ–‡çŒ® id é›†
let litFilterIDs = [];     // â€œæŸ¥çœ‹å…³è”æ–‡çŒ®â€ æ—¶ç”¨çš„è¿‡æ»¤
let assocNoteId = null;     // å½“å‰æ­£åœ¨å…³è”çš„ç¬”è®° id




$('#page-size').value = ps;

/*************************
 * Datalist æ„å»º
 *************************/
function refreshDatalists() {
  $('#folder-list').innerHTML = data.folders.map(f => `<option value="${f}">`).join('');
  $('#author-list').innerHTML = uniq(data.literature.map(l => l.author).filter(Boolean)).map(a => `<option value="${a}">`).join('');
  $('#tag-list-dl').innerHTML = uniq(data.literature.flatMap(l => l.tags || [])).map(t => `<option value="${t}">`).join('');
  // æœç´¢å»ºè®®
  const suggestions = uniq([
    ...data.literature.map(l => l.title),
    ...data.literature.flatMap(l => l.tags || []),
    ...data.literature.map(l => l.author).filter(Boolean)
  ]);
  $('#search-suggestions').innerHTML = suggestions.map(s => `<option value="${s}">`).join('');
  buildSearchTags();
}

/*************************
 * è¿‡æ»¤å™¨ï¼ˆæ”¶è—å¤¹ / æ¯é¡µï¼‰
 *************************/
function refreshFilters() { setSel($('#folder-filter'), ['å…¨éƒ¨', ...data.folders], curFolder); }

/*************************
 * ä¾§æ  Tag é¢æ¿
 *************************/
function buildTagPanel() {
  const box = $('#tag-list');
  if (!box) return;

  // æ”¶é›†æ‰€æœ‰ Tag
  const allTags = Array.from(
    new Set(data.literature.flatMap(l => l.tags || []))
  ).sort();

  box.innerHTML = '';

  allTags.forEach(tag => {
    /* é»˜è®¤èƒ¶å›Š */
    const span = document.createElement('span');
    span.className = 'chip mr-1 mb-1';
    span.textContent = tag;

    if (!tagEditMode) {
      /* â€”â€” æ™®é€šæ¨¡å¼ï¼šç‚¹å‡»å¤šé€‰ â€”â€” */
      span.onclick = () => {
        if (tagFilters.includes(tag)) {
          tagFilters = tagFilters.filter(t => t !== tag);
          span.classList.remove('bg-blue-100');
        } else {
          tagFilters.push(tag);
          span.classList.add('bg-blue-100');
        }
        page = 1; renderLit();
      };
      if (tagFilters.includes(tag)) span.classList.add('bg-blue-100');
      box.appendChild(span);
    } else {
      /* â€”â€” ç¼–è¾‘æ¨¡å¼ï¼šåŒ…ä¸€å±‚ div + å°æŒ‰é’® â€”â€” */
      const wrapper = document.createElement('div');
      wrapper.className = 'tag-wrap'; 

      /* åˆ é™¤æŒ‰é’® */
      const del = document.createElement('button');
      del.textContent = 'âŒ';
      del.title = 'åˆ é™¤';
      del.className = 'tag-btn del'
      del.onclick = e => {
        e.stopPropagation();
        if (!confirm(`ç¡®å®šåˆ é™¤ Tag "${tag}"ï¼Ÿ`)) return;
        data.literature.forEach(l => {
          if (l.tags) l.tags = l.tags.filter(t => t !== tag);
        });
        save(); buildTagPanel(); renderLit();
      };

      /* é‡å‘½åæŒ‰é’® */
      const ren = document.createElement('button');
      ren.innerHTML = 'ğŸ’™';
      ren.title = 'é‡å‘½å';
      ren.className = 'tag-btn ren';
      ren.onclick = e => {
        e.stopPropagation();
        toInput(wrapper, tag);
      };

      wrapper.appendChild(span);
      wrapper.appendChild(del);
      wrapper.appendChild(ren);
      box.appendChild(wrapper);
    }
  });

  /* å†…è”æ”¹åï¼šspan â†’ input */
  function toInput(wrapper, oldTag) {
    const input = document.createElement('input');
    input.type  = 'text';
    input.value = oldTag;
    input.className = 'border rounded px-1 text-xs';

    const saveRename = () => {
      const newTag = input.value.trim();
      if (!newTag || newTag === oldTag) return rebuild();
      const exists = allTags.includes(newTag);
      if (exists) { alert('å·²å­˜åœ¨åŒå Tag'); return; }

      data.literature.forEach(l => {
        if (l.tags) l.tags = l.tags.map(t => (t === oldTag ? newTag : t));
      });
      save(); rebuild();
    };

    const rebuild = () => { buildTagPanel(); renderLit(); };

    input.onkeydown = e => {
      if (e.key === 'Enter') saveRename();
      if (e.key === 'Escape') rebuild();
    };
    input.onblur    = rebuild;

    wrapper.innerHTML = '';        // æ¸…ç©ºåŸå†…å®¹
    wrapper.appendChild(input);
    input.focus();
  }
}


/*************************
 * æœç´¢æç¤ºåŒºï¼ˆä¸‰ç±»ç­›é€‰æŒ‰é’®ï¼‰
 *************************/
function buildSearchTags() {
  const area = $('#search-tags'); area.innerHTML = '';
  // ä½œè€…/å›¢ç»„
  const authors = uniq(data.literature.map(l => l.author).filter(Boolean));
  if (authors.length) {
    const wrap = document.createElement('div');
    wrap.className = 'space-y-1';
    // ç¬¬ä¸€è¡Œ label + å…¨éƒ¨
    const row1 = document.createElement('div');
    row1.className = 'flex items-center gap-1';
    row1.innerHTML = `<span class="font-medium">ä½œè€…/å›¢ç»„:</span><span class="chip ${authorFilter==='å…¨éƒ¨'?'chip-selected':''}" data-author="å…¨éƒ¨">å…¨éƒ¨</span>`;
    wrap.appendChild(row1);
    // ç¬¬äºŒè¡Œ chips
    const row2 = document.createElement('div'); row2.className = 'flex flex-wrap gap-1';
    authors.forEach(a => {
      const span = document.createElement('span');
      span.textContent = a;
      span.dataset.author = a;
      span.className = `chip chip-author${authorFilter===a?' chip-selected':''}`;
      row2.appendChild(span);
    });
    wrap.appendChild(row2);
    area.appendChild(wrap);
  }
  // é‡è¦ç¨‹åº¦
  const wrapImp = document.createElement('div'); wrapImp.className = 'space-y-1 mt-2';
  const row1i = document.createElement('div'); row1i.className = 'flex items-center gap-1';
  row1i.innerHTML = `<span class="font-medium">é‡è¦ç¨‹åº¦:</span><span class="chip ${importanceFilter==='å…¨éƒ¨'?'chip-selected':''}" data-imp="å…¨éƒ¨">å…¨éƒ¨</span>`;
  wrapImp.appendChild(row1i);
  const row2i = document.createElement('div'); row2i.className='flex flex-wrap gap-1';
  ['1','2','3','4'].forEach(v=>{
    const span=document.createElement('span');
    span.textContent=v;
    span.dataset.imp=v;
    span.className=`chip chip-imp${importanceFilter===v?' chip-selected':''}`;
    row2i.appendChild(span);
  });
  wrapImp.appendChild(row2i);
  area.appendChild(wrapImp);
  // é˜…è¯»æƒ…å†µ
  const wrapRead=document.createElement('div');wrapRead.className='space-y-1 mt-2';
  const row1r=document.createElement('div');row1r.className='flex items-center gap-1';
  row1r.innerHTML=`<span class="font-medium">é˜…è¯»æƒ…å†µ:</span><span class="chip ${readFilter==='å…¨éƒ¨'?'chip-selected':''}" data-read="å…¨éƒ¨">å…¨éƒ¨</span>`;
  wrapRead.appendChild(row1r);
  const row2r=document.createElement('div');row2r.className='flex flex-wrap gap-1';
  ['æœªè¯»','åªæµ…è¯»','å·²è¯»','å·²ç²¾è¯»'].forEach(r=>{
    const span=document.createElement('span');span.textContent=r;span.dataset.read=r;span.className=`chip chip-read${readFilter===r?' chip-selected':''}`;row2r.appendChild(span);
  });
  wrapRead.appendChild(row2r);
  area.appendChild(wrapRead);
}
// ç‚¹å‡»å¤„ç†
$('#search-tags').addEventListener('click',e=>{
  const t=e.target;if(!t.classList.contains('chip')) return;
  if(t.dataset.author!==undefined){ authorFilter = (authorFilter===t.dataset.author?'å…¨éƒ¨':t.dataset.author); }
  else if(t.dataset.imp!==undefined){ importanceFilter = (importanceFilter===t.dataset.imp?'å…¨éƒ¨':t.dataset.imp); }
  else if(t.dataset.read!==undefined){ readFilter = (readFilter===t.dataset.read?'å…¨éƒ¨':t.dataset.read); }
  buildSearchTags(); page=1; renderLit();
});

/*************************
 * æ–‡çŒ®åˆ—è¡¨æ¸²æŸ“ (å«å¤š Tag + ä¸‰ç±»è¿‡æ»¤)
 *************************/
/* ========= æ–‡çŒ®åˆ—è¡¨æ¸²æŸ“ ========= */
function renderLit(globalSearch = false) {
  const list = $('#lit-list');
  list.innerHTML = '';

  /* â€”â€”â€”â€”â€” 1. æ•°æ®å‡†å¤‡ â€”â€”â€”â€”â€” */
  let arr = [...data.literature];

  /* â‘  è‹¥åœ¨â€œæŸ¥çœ‹å…³è”æ–‡çŒ®â€çŠ¶æ€ï¼Œä»…ä¿ç•™æŒ‡å®š id */
  if (litFilterIDs.length) {
    globalSearch = true;
    arr = arr.filter(l => litFilterIDs.includes(l.id));
  }

  /* â‘¡ å¸¸è§„è¿‡æ»¤ï¼ˆå½“ä¸æ˜¯å…¨å±€æœç´¢æ—¶æ‰ç”¨æ–‡ä»¶å¤¹ / Tag / é‡è¦åº¦â€¦ï¼‰ */
  if (!globalSearch) {
    if (curFolder      !== 'å…¨éƒ¨') arr = arr.filter(l => l.folders.includes(curFolder));
    if (tagFilters.length)         arr = arr.filter(l => tagFilters.every(t => (l.tags || []).includes(t)));
    if (authorFilter   !== 'å…¨éƒ¨') arr = arr.filter(l => l.author === authorFilter);
    if (importanceFilter !== 'å…¨éƒ¨') arr = arr.filter(l => String(l.importance) === importanceFilter);
    if (readFilter     !== 'å…¨éƒ¨') arr = arr.filter(l => l.read === readFilter);
  }

  /* â‘¢ å…³é”®è¯æœç´¢ */
  if (searchTxt) {
    const kw = searchTxt.toLowerCase();
    arr = arr.filter(l =>
      [l.title, l.author, (l.tags || []).join(',')].join('\u0000').toLowerCase().includes(kw)
    );
  }

  /* â€”â€”â€”â€”â€” 2. åˆ†é¡µè®¡ç®— â€”â€”â€”â€”â€” */
  const maxPage = Math.max(1, Math.ceil(arr.length / ps));
  if (page > maxPage) page = maxPage;

  const pageArr = arr.slice((page - 1) * ps, page * ps);

  /* â€”â€”â€”â€”â€” 3. é€æ¡æ¸²æŸ“ â€”â€”â€”â€”â€” */
  pageArr.forEach(l => {
    /* æ ‡ç­¾ chips */
    const chips = [
      ...(l.tags || []).map(t => `<span class='chip mr-1'>${t}</span>`)
    ];
    if (l.author)      chips.push(`<span class='chip bg-green-200 mr-1'>ğŸ‘¤${l.author}</span>`);
    if (l.importance)  chips.push(`<span class='chip bg-red-200 mr-1'>â­${l.importance}</span>`);
    if (l.read)        chips.push(`<span class='chip bg-blue-200 mr-1'>ğŸ“–${l.read}</span>`);

    /* å…³è”æ¨¡å¼ï¼šé€‰ä¸­çŠ¶æ€ & æ˜¯å¦æ˜¾ç¤ºæŒ‰é’®æ¡ */
    const isSel   = assocMode && assocSel.includes(l.id);
    const liClass = [
      'bg-gray-50 p-2 rounded relative group',
      assocMode ? 'cursor-pointer' : 'hover:bg-gray-100',
      isSel ? 'assoc-selected' : ''
    ].join(' ');

    const btnBar  = assocMode
      ? ''   /* é€‰æ–‡çŒ®æ—¶éšè—ç®¡ç†/åˆ é™¤é”® */
      : `<div class='flex gap-1 opacity-0 group-hover:opacity-100'>
           <button class='link-btn   text-xs text-emerald-600' title='æ›´æ–°é“¾æ¥'>ğŸ”—</button>
           <button class='manage-btn text-xs text-blue-600'>âš™ï¸</button>
           <button class='del-btn text-xs text-red-600'>ğŸ—‘ï¸</button>
         </div>`;

    /* ä¸»æ ‡é¢˜ / é“¾æ¥ */
    const titleHTML = l.path
      ? `<a href='${l.path}' target='_blank' class='text-blue-600 underline'>
           ${l.title || l.path.split('/').pop()}
         </a>`
      : l.title;

    /* æ’å…¥ DOM */
    list.insertAdjacentHTML(
      'beforeend',
      `<li class='${liClass}' data-id='${l.id}'>
         <div class='flex justify-between items-start gap-1'>
           <span class='flex-1 break-all'>${titleHTML}</span>
           ${btnBar}
         </div>
         <div class='mt-1'>${chips.join('')}</div>
       </li>`
    );

    /* äº‹ä»¶ç»‘å®š */
    const liEl = list.lastElementChild;

    if (assocMode) {
      /* â€”â€” å…³è”æ¨¡å¼ï¼šç‚¹æ•´æ¡åˆ‡æ¢é€‰ä¸­ â€”â€” */
      liEl.addEventListener('click', e => {
        if (e.target.tagName === 'A') return;      // ç‚¹å‡»è¶…é“¾æ¥ä¸è§¦å‘
        const id = liEl.dataset.id;
        const idx = assocSel.indexOf(id);
        if (idx > -1) {
          assocSel.splice(idx, 1);
          liEl.classList.remove('assoc-selected');
        } else {
          assocSel.push(id);
          liEl.classList.add('assoc-selected');
        }
      });
    } else {
      /* â€”â€” æ™®é€šæ¨¡å¼ï¼šç®¡ç† / åˆ é™¤ â€”â€” */
      liEl.querySelector('.manage-btn')?.addEventListener('click',
        e => openManageModal(liEl.dataset.id));
      liEl.querySelector('.del-btn')?.addEventListener('click',
        e => deleteLitHandler(liEl.dataset.id));
      liEl.querySelector('.link-btn')?.addEventListener(
        'click',
        e => updateLitLink(liEl.dataset.id)
      );
    }
  });

  /* â€”â€”â€”â€”â€” 4. åˆ†é¡µæŒ‰é’® â€”â€”â€”â€”â€” */
  pagination(maxPage);
}


/*************************
 * åˆ†é¡µæ§ä»¶
 *************************/
function pagination(max){
  const pg=$('#pagination'); pg.innerHTML='';
  const mkBtn=(txt,dis)=>`<button class='px-3 py-1 border rounded ${dis?'opacity-40':''}' ${dis?'disabled':''}>${txt}</button>`;
  pg.insertAdjacentHTML('beforeend',mkBtn('ä¸Šä¸€é¡µ',page===1));
  pg.insertAdjacentHTML('beforeend',`<span class='mx-2'>${page}/${max}</span>`);
  pg.insertAdjacentHTML('beforeend',mkBtn('ä¸‹ä¸€é¡µ',page===max));
  pg.querySelectorAll('button')[0].onclick=()=>{page--;renderLit();};
  pg.querySelectorAll('button')[1].onclick=()=>{page++;renderLit();};
}

/*************************
 * æ·»åŠ æ–‡çŒ®
 *************************/
function addLitHandler(){
  const path=$('#lit-path').value.trim();
  if(!path){alert('è·¯å¾„ä¸èƒ½ä¸ºç©º');return;}
  let title=$('#lit-title').value.trim();
  if(!title) title = path.split(/[\\/]/).pop();
  const folders=$('#lit-folders').value.split(',').map(s=>s.trim()).filter(Boolean);
  folders.forEach(f=>{ if(f && !data.folders.includes(f)) data.folders.push(f); });
  const author=$('#lit-author').value.trim();
  const importance=$('#lit-importance').value;
  const read=$('#lit-read').value;
  if(data.literature.some(l=>l.title===title && l.path===path)) return alert('å·²å­˜åœ¨åŒåæ–‡çŒ®');
  data.literature.push({id:gid(),title,path,folders:folders.length?folders:['é»˜è®¤'],tags:[...folders],author,importance,read});
  save();
  ['#lit-title','#lit-path','#lit-folders','#lit-author'].forEach(sel=>$(sel).value='');
  $('#lit-importance').value=''; $('#lit-read').value='';
  refreshDatalists(); refreshFilters(); buildTagPanel(); renderLit();
}
$('#add-lit').addEventListener('click',addLitHandler);

/*************************
 * æ‹–æ‹½ / æ‰¹é‡ä¸Šä¼ 
 *************************/
$('#open-drop').addEventListener('click',()=>$('#drop-modal').classList.remove('hidden'));
$('#close-modal').addEventListener('click',()=>$('#drop-modal').classList.add('hidden'));

// Prevent default for window drag
['dragover','drop'].forEach(evt=>window.addEventListener(evt,e=>e.preventDefault()));
['dragenter','dragover'].forEach(evt=>$('#drop-zone').addEventListener(evt,e=>{e.preventDefault(); e.currentTarget.classList.add('bg-indigo-50');}));
['dragleave','drop'].forEach(evt=>$('#drop-zone').addEventListener(evt,e=>{e.preventDefault(); e.currentTarget.classList.remove('bg-indigo-50');}));
$('#drop-zone').addEventListener('drop',e=>{ filesAdd(e.dataTransfer.files); });
$('#choose-folder').addEventListener('click',()=>$('#folder-input').click());
$('#folder-input').addEventListener('change',e=>{ filesAdd(e.target.files,true); e.target.value=''; });

function filesAdd(fs, rel = false) {
  let add = 0;
  [...fs].forEach(f => {
    const ext = f.name.slice(f.name.lastIndexOf('.')).toLowerCase();
    if (!['.pdf', '.doc', '.docx', '.txt', '.md'].includes(ext)) return;

    // 1) å®Œæ•´ç›¸å¯¹è·¯å¾„  (å«å­ç›®å½•)
    const path = './' + (rel && f.webkitRelativePath ? f.webkitRelativePath : f.name);
    // 2) åŒåæ–‡ä»¶å»é‡ï¼šè‹¥å·²å­˜åœ¨å°±åªæ›´æ–° path
    const existed = data.literature.find(l => l.title === f.name);
    if (existed) {
      if (existed.path !== path) existed.path = path;            // ä»…æ”¹è·¯å¾„
      return;                                                    // ä¸æ–°å¢
    }


    // 2) folders = é¡¶å±‚ç›®å½•
    //    tags = é¡¶å±‚ + æ¬¡çº§ç›®å½•(è‹¥å­˜åœ¨ä¸”ä¸æ˜¯æ–‡ä»¶å)
    let folders = [], tags = [];
    if (rel && f.webkitRelativePath) {
      const parts = f.webkitRelativePath.split('/');
      const root = parts[0];                 // 21cm
      folders = [root];
      tags = [root];
      if (parts.length >= 3 && parts[1]) {            // è‹¥å­˜åœ¨ä¸€çº§å­ç›®å½•
        folders.push(parts[1]);
        tags.push(parts[1]);
      } 
      folders.forEach(fd => { if (!data.folders.includes(fd)) data.folders.push(fd); });
    }

    // 3) å…¥åº“
    data.literature.push({
      id: gid(),
      title: f.name,
      path,
      folders: folders.length ? folders : ['é»˜è®¤'],
      tags,
      author: '',
      importance: '',
      read: ''
    });
    add++;
  });
  

  if (add) alert(`æ–°å¢ ${add} ç¯‡æ–‡çŒ®`);
  save();
  $('#drop-modal').classList.add('hidden');
  refreshDatalists(); refreshFilters(); buildTagPanel(); renderLit();



  // 6) UI åˆ·æ–°
  if (add) alert('æ–°å¢ ' + add + ' ç¯‡æ–‡çŒ®');
  save();
  $('#drop-modal').classList.add('hidden');
  refreshDatalists();
  refreshFilters();
  buildTagPanel();
  renderLit();
}

/*************************************************
 *  â”€â”€ ç¬”è®°æ¨¡å— â”€â”€
 *  ä¾èµ–å…¨å±€ï¼šdataã€save()ã€renderLit()ã€gid()
 *************************************************/

/* ğŸ”„ æŠŠå½“å‰æ–‡çŒ®åˆ—è¡¨æ¸²æŸ“æˆå¯å‹¾é€‰åˆ—è¡¨ */
function updateLitCheckbox (preSel = []) {
  const box = $('#link-lit');
  if (!box) return;
  box.innerHTML = '';
  data.literature.forEach(l => {
    const label = document.createElement('label');
    label.className = 'flex items-center gap-1 mr-3 mb-1';
    label.innerHTML =
      `<input type="checkbox" value="${l.id}" ${preSel.includes(l.id) ? 'checked' : ''}>
       <span>${l.title}</span>`;
    box.appendChild(label);
  });
}

/* ğŸ“‘ æ¸²æŸ“å·¦ä¾§ç¬”è®°ç›®å½• */
function renderNotes () {
  const ul = $('#note-list'); ul.innerHTML='';
  data.notes.forEach(n=>{
    const refs = data.literature
                   .filter(l=>n.litIds.includes(l.id))
                   .map(l=>l.title);
    const li = document.createElement('li');
    li.className='flex flex-col gap-1';
    li.innerHTML = `
      <div class="flex items-center gap-2">
        <span class="flex-1 cursor-pointer hover:underline" data-id="${n.id}">${n.title}</span>
        <button class="text-blue-600"
            onclick="startAssociate('${n.id}')">â•</button>
        <button class="text-blue-600" data-edit="${n.id}">âœï¸</button>
        <button class="text-red-600"  data-del ="${n.id}">ğŸ—‘</button>
        <button class="text-purple-600" data-show="${n.id}" title="åªçœ‹å…³è”æ–‡çŒ®">ğŸ”</button>
      </div>
      ${refs.length?`<div class="text-xs text-gray-500 truncate ml-6">å…³è”: ${refs.join(' , ')}</div>`:''}`;
    li.onclick = e=>{
      if(e.target.dataset.edit)   editNote(e.target.dataset.edit);
      else if(e.target.dataset.del) deleteNote(e.target.dataset.del);
      else if(e.target.dataset.show){ litFilterIDs = [...n.litIds]; page=1; renderLit(true); }
      else if(e.target.dataset.id)  showNote(e.target.dataset.id);
    };
    ul.appendChild(li);
  });
}



/*******************************************
 * ä¿å­˜ / æ›´æ–°ç¬”è®°  (æ‰¹é‡æ–‡ä»¶å¤¹ + å•è·¯å¾„)
 *******************************************/
$('#add-note')?.addEventListener('click', () => {
  /* ===== åŸºæœ¬è¾“å…¥ ===== */
  const titleInput  = $('#note-title');
  const mdInput     = $('#note-md');
  let   title       = titleInput.value.trim();
  const mdText      = mdInput.value.trim();

  const litIds = [...assocSel];   // â† æ”¹æˆç›´æ¥ç”¨å…¨å±€é€‰ä¸­


  /* ===== ä¸Šä¼ å…¥å£ ===== */
  const dirInput    = $('#note-folder');          // é€‰æ–‡ä»¶å¤¹
  const pathInput   = $('#note-path-manual');     // æ‰‹åŠ¨è·¯å¾„
  const manualPath  = pathInput.value.trim();

  /* ---- 1) æ”¶é›† folder ä¸­çš„å…¨éƒ¨ PDF ---- */
  let files = [];
  if (dirInput && dirInput.files.length) {
    files = [...dirInput.files]
              .filter(f => f.name.toLowerCase().endsWith('.pdf'));
  }

  /* ---- 2) å¦‚æœ‰æ‰‹åŠ¨è·¯å¾„ï¼Œæ„é€ ä¸€ä¸ªâ€œä¼ª Fileâ€ å¹¶ push ---- */
  /* ---- æ‰‹åŠ¨è·¯å¾„ï¼šæ„é€ ä¼ª File ---- */
  if (manualPath) {
    let rel = manualPath.trim();

  // â‘  å¦‚æœæ˜¯ç»å¯¹è·¯å¾„å¹¶ä¸”ä½äº HTML åŒç›®å½•æˆ–å­ç›®å½• â†’ è½¬ç›¸å¯¹è·¯å¾„
    if (rel.startsWith('/')) {
      const baseDir = decodeURIComponent(window.location.pathname)
                     .replace(/[^\/]*$/, '');            // /â€¦/å­¦ä¹ /
      if (rel.startsWith(baseDir)) {
        rel = '.' + rel.slice(baseDir.length);             // ./ç¬”è®°/xxx.pdf
      } else {
        rel = 'file://' + rel;                             // fallbackï¼šfile:///â€¦
      }
    } else if (!rel.startsWith('./') && !rel.startsWith('../')){
      rel = './' + rel;                                    // è£¸æ–‡ä»¶å â†’ ./xxx.pdf
    }

    const fake = new File([], rel.split('/').pop());
    fake._manualPath = rel;
    files.push(fake);
  }


  /* ===== ç¼–è¾‘æ¨¡å¼ ===== */
  if (editingId) {
    const n = data.notes.find(x => x.id === editingId);
    if (!n) return alert('ç¬”è®°ä¸å­˜åœ¨ï¼');

    /* ä»…å– files[0] æ›¿æ¢ç°æœ‰é™„ä»¶ï¼ˆç¼–è¾‘æ¨¡å¼ä¸åšæ‰¹é‡ï¼‰ */
    if (files.length) {
      const f   = files[0];
      const rel = './' + (f.webkitRelativePath || f._manualPath || f.name);
      n.type = 'file';
      n.path = rel;
      if (!title) title = f.name.replace(/\.[^/.]+$/, '');
    }

    n.title  = title || n.title;
    n.litIds = litIds;
    if (n.type !== 'file') n.markdown = mdText;
    editingId = null;

  /* ===== æ–°å»ºæ¨¡å¼ ===== */
  } else {

    /* å¾ªç¯ filesï¼šæ‰¹é‡ç”Ÿæˆå¤šæ¡ PDF ç¬”è®° */
    files.forEach(f => {
      const rel = './' + (f.webkitRelativePath || f._manualPath || f.name);
      const autoTitle = f.name.replace(/\.[^/.]+$/, '');

      data.notes.push({
        id: gid(),
        title: title || autoTitle,
        litIds,
        type: 'file',
        path: rel
      });
    });

    /* è‹¥æœ‰ Markdown ä¸”æœªä¸Šä¼ æ–‡ä»¶ï¼Œåˆ™å•ç‹¬ç”Ÿæˆä¸€æ¡ MD ç¬”è®° */
    if (!files.length && mdText) {
      if (!title) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©ºï¼');
      data.notes.push({
        id: gid(),
        title,
        litIds,
        type: 'markdown',
        markdown: mdText
      });
    }
  }

  /* ===== æ¸…ç† & åˆ·æ–° ===== */
  save();
  titleInput.value   = '';
  mdInput.value      = '';
  dirInput.value     = '';
  pathInput.value    = '';
  assocSel = [];
  assocNoteId = null;
  updateLitCheckbox();
  renderNotes();
});

/* ==== å…³è”æ–‡çŒ®æŒ‰é’® ==== */
$('#start-assoc').onclick = ()=>{
  assocMode = true;
  assocSel  = editingId
      ? [...(data.notes.find(n=>n.id===editingId)?.litIds || [])]
      : [...assocSel];
  $('#start-assoc').classList.add('hidden');
  $('#finish-assoc').classList.remove('hidden');
  renderLit();
};

function startAssociate(noteId){
  assocMode   = true;
  assocNoteId = noteId;                         // è®°å½•ç›®æ ‡ç¬”è®°
  assocSel    = [...(data.notes.find(n=>n.id===noteId)?.litIds||[])]; // é¢„å‹¾é€‰å·²æœ‰
  // æŒ‰é’®æ˜¾éš
  document.getElementById('start-assoc').classList.add('hidden');
  document.getElementById('finish-assoc').classList.remove('hidden');
  document.getElementById('start-assoc').onclick = ()=>startAssociate(editingId ?? gid());
  renderLit();                                  // è¿›å…¥è“åº•å¯ç‚¹é€‰æ¨¡å¼
}


$('#finish-assoc').onclick = ()=>finishAssoc();
document.addEventListener('keydown',e=>{ if(assocMode && e.key==='Enter') finishAssoc(); });

function finishAssoc(){
  // å†™å›åˆ°ç›®æ ‡ç¬”è®°
  if(assocNoteId){
    const n = data.notes.find(x=>x.id===assocNoteId);
    if(n) n.litIds = [...assocSel];
    save();
    renderNotes();              // åˆ·æ–°å·¦ä¾§ç›®å½•â€œå…³è”: â€¦â€
  }
  // é€€å‡ºæ¨¡å¼
  assocMode   = false;
  assocSel    = [];
  assocNoteId = null;
  document.getElementById('finish-assoc').classList.add('hidden');
  document.getElementById('start-assoc').classList.remove('hidden');
  document.addEventListener('keydown', e=>{
    if(assocMode && e.key==='Enter') finishAssoc();
  });

  renderLit();                  // æ¢å¤æ­£å¸¸åˆ—è¡¨
}



function editNote(id, linkOnly=false){
  const n = data.notes.find(x => x.id === id);
  if(!n) return;

  editingId = n.id;
  $('#note-title').value = linkOnly ? '' : n.title;              // linkOnly æ—¶ä¸åŠ¨æ ‡é¢˜æ­£æ–‡
  $('#note-md').value    = linkOnly || n.type==='file' ? '' : n.markdown || '';
  updateLitCheckbox(n.litIds);

  if(linkOnly){
    // æŠŠé¡µé¢æ»šåˆ°â€œâ€å¤é€‰æ¡†åŒº
    document.getElementById('link-lit')?.scrollIntoView({behavior:'smooth', block:'center'});
    alert('å·²è¿›å…¥â€œå…³è”æ–‡çŒ®â€ç¼–è¾‘æ¨¡å¼ï¼Œå‹¾é€‰åç›´æ¥ä¿å­˜å³å¯');
  }else{
    alert('å·²åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼ï¼Œä¿®æ”¹åä¿å­˜å³å¯æ›´æ–°');
  }
}



/* ğŸ—‘ åˆ é™¤ç¬”è®° */
function deleteNote (id) {
  if (!confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”è®°ï¼Ÿ')) return;
  data.notes = data.notes.filter(n => n.id !== id);
  save();
  renderNotes();
}

/* ğŸ“– æŸ¥çœ‹ç¬”è®°è¯¦æƒ…ï¼ˆä¸ showLit å…±ç”¨ #viewï¼‰ */
function showNote (id) {
  const n = data.notes.find(x => x.id === id);
  const v = $('#view');
  const rel = data.literature.filter(l => n.litIds.includes(l.id));
  const relHTML = rel.length
    ? rel.map(l=>`<li><a href="${l.path}" target="_blank" class="text-blue-600 underline">${l.title}</a></li>`).join('')
    : '<li>æš‚æ— </li>';

  v.innerHTML = `
    <button class="mb-2 text-sm text-red-600" onclick="hideView()">è¿”å›</button>
    <button class="mb-2 ml-2 text-sm text-blue-600" onclick="editNote('${n.id}')">ç»§ç»­ç¼–è¾‘</button>
    <button class="px-3 py-2 bg-blue-500 text-white rounded"
        onclick="startAssociate('${n.id}')">â• å…³è”æ–‡çŒ®</button>


    <h2 class="text-xl font-bold mb-2">${n.title}</h2>
    ${
      n.type === 'file'
        ? `<iframe src="${n.path}" class="w-full h-[65vh] border mb-4"></iframe>`
        : `<article class="prose max-w-none mb-4">${marked.parse(n.markdown)}</article>`
    }
    <h3 class="font-semibold mb-1">å…³è”æ–‡çŒ®</h3>
    <ul class="list-disc pl-5">${relHTML}</ul>`;
  v.classList.remove('hidden');
}


/* â†©ï¸ éšè—å³ä¾§è¯¦æƒ…åŒºï¼ˆå…±ç”¨å‡½æ•°å³å¯ï¼‰ */
function hideView () {
  $('#view')?.classList.add('hidden');
}

/* ğŸ“Œ åˆå§‹æ¸²æŸ“ï¼ˆåœ¨é¡µé¢åŠ è½½å®Œæ¯•åè°ƒç”¨ä¸€æ¬¡ï¼‰ */
updateLitCheckbox();
renderNotes();


            
     

/*************************
 * åˆ é™¤é€»è¾‘
 *************************/
function deleteLitHandler(id){
  if(!confirm('ç¡®å®šåˆ é™¤?')) return;
  data.literature = data.literature.filter(l=>l.id!==id);
  save();
  refreshDatalists(); buildTagPanel(); renderLit();
}

/* === å•ç¯‡æ–‡çŒ®ï¼šæ›´æ–°è·¯å¾„ / é“¾æ¥ === */
function updateLitLink(id){
  const lit = data.literature.find(l=>l.id===id);
  if(!lit) return;

  const neu = prompt('è¾“å…¥æ–°çš„ PDF è·¯å¾„æˆ– URLï¼š', lit.path);
  if(!neu || neu === lit.path) return;

  // å¯åœ¨æ­¤å¤„åšåˆæ³•æ€§æ ¡éªŒï¼Œå¦‚åªå…è®¸ .pdf
  const isAbs = /^(https?:\/\/|file:\/\/|\/|[a-zA-Z]:[\\/])/.test(neu);
  lit.path = isAbs || neu.startsWith('./') ? neu : './' + neu;

  save();
  renderLit();         // ç«‹å³åˆ·æ–°åˆ—è¡¨
  alert('å·²æ›´æ–°æ–‡çŒ®é“¾æ¥ï¼');
}


/*************************
 * ç®¡ç†æ¨¡æ€ (ä¿æŒä¸å˜)
 *************************/
let currentManageId = null;

function openManageModal(id) {
  currentManageId = id;
  const lit = data.literature.find(l => l.id === id); if (!lit) return;
  $('#manage-title').textContent = 'ç®¡ç†æ–‡çŒ® â€“ ' + lit.title;
  
  buildManageFolders(); 
  document.getElementById('folder-suggestions').innerHTML = '';  // åªæ¸…ç©º
  
  const box = $('#manage-folders'); box.innerHTML = '';
  data.folders.forEach(f => box.insertAdjacentHTML('beforeend', `<label class='flex items-center gap-1 mr-2'><input type='checkbox' value='${f}' ${lit.folders.includes(f) ? 'checked' : ''}>${f}</label>`));
  $('#manage-author').value = lit.author || '';
  $('#manage-importance').value = lit.importance || '';
  $('#manage-read').value = lit.read || '';
  const tagBox = $('#manage-tags-box'); tagBox.innerHTML = '';
  (lit.tags || []).forEach(addTagChip);
  $('#manage-tag-input').value = '';
  $('#manage-modal').classList.remove('hidden');
}

$('#save-manage').onclick = () => {
  const lit = data.literature.find(l => l.id === currentManageId); if (!lit) return;
  lit.folders = [...$('#manage-folders').querySelectorAll('input:checked')].map(c => c.value);
  if (!lit.folders.length) lit.folders = ['é»˜è®¤'];
  lit.author = $('#manage-author').value.trim();
  lit.importance = $('#manage-importance').value;
  lit.read = $('#manage-read').value;
  const extraTags = [...$('#manage-tags-box').children].map(c => c.dataset.tag);
  lit.tags = uniq(extraTags);
  save();
  $('#manage-modal').classList.add('hidden');
  refreshDatalists(); refreshFilters(); buildTagPanel(); buildSearchTags(); renderLit();refreshFolderSuggestions();
};

$('#close-manage-modal').onclick = () => $('#manage-modal').classList.add('hidden');
/* ========== æ–°å»ºæ”¶è—å¤¹æŒ‰é’®ï¼ˆç®¡ç†æ¨¡æ€é‡Œï¼‰ ========== */
$('#new-folder-btn').onclick = addNewFolder;
$('#new-folder-input').addEventListener('keydown',e=>{
  if(e.key==='Enter') addNewFolder();
});

function addNewFolder(){
  const inp  = $('#new-folder-input');
  const name = inp.value.trim();
  if(!name) return;

  /* 1) è‹¥å…¨å±€æ²¡æœ‰ â†’ æ–°å»ºå¹¶åˆ·æ–° datalist / ä¾§æ  */
  let isNew = false;
  if(!data.folders.includes(name)){
    data.folders.push(name);
    refreshFilters(); 
    isNew = true;
  }

  /* 2) ç»™å½“å‰æ–‡çŒ®å‹¾é€‰è¯¥æ”¶è—å¤¹ */
  const lit = data.literature.find(l => l.id === currentManageId);
  if(lit && !lit.folders.includes(name)){
    lit.folders.push(name);
  }

  save();
  inp.value = '';

  /* 3) UIï¼šå¦‚æœæ˜¯æ–°å»º â†’ appendï¼›å¦åˆ™åªæŠŠå·²æœ‰å¤é€‰æ¡†æ‰“å‹¾ */
  const box = $('#manage-folders');
  let cb = box.querySelector(`input[value="${name}"]`);
  if(!cb){
    box.insertAdjacentHTML('beforeend',
      `<label class='flex items-center gap-1 mr-2'>
         <input type='checkbox' value='${name}' checked>${name}
       </label>`);
  }else{
    cb.checked = true;
  }
}



function refreshFolderSuggestions(){
  const dl = document.getElementById('folder-suggestions');
  if(!dl) return;
  dl.innerHTML = '';
  data.folders.forEach(f=>{
    const opt = document.createElement('option');
    opt.value = f;
    dl.appendChild(opt);
  });
}
/* å®æ—¶æç¤ºï¼šåªæœ‰è¾“å…¥åæ‰æ˜¾ç¤ºåŒ¹é…æ”¶è—å¤¹ */
const nfInput = document.getElementById('new-folder-input');
nfInput.addEventListener('input', e=>{
  const kw = e.target.value.trim().toLowerCase();
  const dl = document.getElementById('folder-suggestions');
  dl.innerHTML = '';
  if(!kw) return;                           // â˜… è¾“å…¥ä¸ºç©ºå°±ä¸å†™ option
  data.folders
      .filter(f => f.toLowerCase().includes(kw))
      .forEach(f => dl.insertAdjacentHTML('beforeend', `<option value="${f}">`));
});



function addTagChip(tag) {
  if (!tag) return;
  const tagBox = $('#manage-tags-box'); if ([...tagBox.children].some(c => c.dataset.tag === tag)) return;
  const span = document.createElement('span'); span.className = 'chip chip-removable mr-1 mt-1'; span.dataset.tag = tag; span.textContent = tag; span.onclick = e => e.currentTarget.remove(); tagBox.appendChild(span);
}
$('#manage-tag-input').addEventListener('keydown', e => { if (['Tab', 'Enter'].includes(e.key)) { e.preventDefault(); const v = e.target.value.trim(); if (v) { addTagChip(v); e.target.value = ''; } } });
$('#manage-tag-input').addEventListener('change', e => { const v = e.target.value.trim(); if (v) { addTagChip(v); e.target.value = ''; } });



/*************************
 * æ”¶è—å¤¹é‡å‘½å
 *************************/
$('#rename-folder').onclick = () => {
  if (curFolder === 'å…¨éƒ¨' || curFolder === 'é»˜è®¤') return alert('æ— æ³•é‡å‘½åæ­¤æ”¶è—å¤¹');
  const newName = prompt('é‡å‘½åæ”¶è—å¤¹ï¼š', curFolder); if (!newName || newName === curFolder) return;
  if (data.folders.includes(newName)) return alert('å·²å­˜åœ¨åŒåæ”¶è—å¤¹');
  data.folders = data.folders.map(f => f === curFolder ? newName : f);
  data.literature.forEach(l => { l.folders = l.folders.map(f => f === curFolder ? newName : f); l.tags = (l.tags || []).map(t => t === curFolder ? newName : t); });
  save(); curFolder = newName;
  refreshDatalists(); refreshFilters(); buildTagPanel(); buildSearchTags(); renderLit();
};

$('#add-folder').onclick = () =>{
  const name = prompt('æ–°å»ºæ”¶è—å¤¹ï¼š');
  if(!name) return;
  if(data.folders.includes(name)) return alert('å·²å­˜åœ¨åŒåæ”¶è—å¤¹');
  data.folders.push(name);
  save();
  refreshDatalists(); refreshFilters();
};

function deleteFolderHandler(name){
  if(!name || name==='å…¨éƒ¨' || name==='é»˜è®¤') return alert('æ— æ³•åˆ é™¤è¯¥æ”¶è—å¤¹');
  const used = data.literature.some(l => l.folders.includes(name));
  if(used && !confirm(`æœ‰æ–‡çŒ®ä»åœ¨æ”¶è—å¤¹ "${name}" ä¸­ã€‚\nåˆ é™¤åè¿™äº›æ–‡çŒ®å°†ç§»è‡³â€œé»˜è®¤â€ã€‚ç»§ç»­ï¼Ÿ`) ) return;

  /* 1) ä»å…¨å±€åˆ—è¡¨ç§»é™¤ */
  data.folders = data.folders.filter(f => f !== name);

  /* 2) æ‰«ææ–‡çŒ®ï¼ŒæŠŠåŒåæ”¶è—å¤¹æ”¹ä¸ºâ€œé»˜è®¤â€ */
  data.literature.forEach(l=>{
    if(l.folders.includes(name)){
      l.folders = l.folders.filter(f=>f!==name);
      if(!l.folders.length) l.folders=['é»˜è®¤'];
    }
  });

  save();
  refreshDatalists(); refreshFilters();           // ä¾§æ ä¸‹æ‹‰
  buildManageFolders?.();                         // è‹¥æ¨¡æ€å·²å¼€
  alert('å·²åˆ é™¤æ”¶è—å¤¹');
}

/* å³ä¾§é¢æ¿æŒ‰é’® */
$('#delete-folder').onclick = ()=>{
  const name = $('#folder-filter').value;
  deleteFolderHandler(name);
};

function buildManageFolders(){
  const box = $('#manage-folders'); if(!box) return;
  const lit = data.literature.find(l=>l.id===currentManageId);
  box.innerHTML='';
  data.folders.forEach(f=>{
    box.insertAdjacentHTML('beforeend',
      `<label class='flex items-center gap-1 mr-2'>
         <input type='checkbox' value='${f}' ${lit.folders.includes(f)?'checked':''}>${f}
       </label>`);
  });
}


/******************************
 *  âœ Tag ç¼–è¾‘ï¼šé‡å‘½å / åˆ é™¤
 ******************************/
$('#edit-tags').onclick = () => {
  tagEditMode = !tagEditMode;                         // åˆ‡æ¢æ¨¡å¼
  $('#edit-tags').textContent = tagEditMode ? 'å®Œæˆ' : 'âœ ç¼–è¾‘';
  buildTagPanel();                                    // é‡æ–°æ¸²æŸ“ Tag åˆ—è¡¨
};

/* ====== ä¸‹è½½æ•°æ® ====== */
$('#export-data').onclick = ()=>{
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href     = url;
  a.download = `bibData_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
};


/* ====== å¯¼å…¥æ•°æ® ====== */
$('#import-data').addEventListener('change', e=>{
  const file = e.target.files[0];
  e.target.value='';                          // æ¸…ç©ºé€‰æ‹©
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ev=>{
    try{
      const obj = JSON.parse(ev.target.result);
      if(!obj.literature || !obj.notes || !obj.folders)
        return alert('JSON ç»“æ„ä¸åˆæ³•ï¼');
      if(!confirm('è¿™å°†è¦†ç›–å½“å‰æ•°æ®ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')) return;

      data = obj;
      save();                                // å†™å› localStorage
      // å…¨é¢åˆ·æ–°å„ UI
      refreshDatalists(); refreshFilters(); buildTagPanel(); buildSearchTags();
      renderNotes(); renderLit();
      alert('å¯¼å…¥æˆåŠŸï¼');
    }catch(err){ alert('è§£æ JSON å¤±è´¥ï¼š'+err.message); }
  };
  reader.readAsText(file,'utf-8');
});


/*************************
 * äº‹ä»¶ç›‘å¬ â€“ å…¶å®ƒ
 *************************/
$('#folder-filter').onchange=e=>{curFolder=e.target.value; page=1; renderLit();};
$('#page-size').onchange=e=>{const v=parseInt(e.target.value); if(v>0){ ps=v; localStorage.setItem('ps',v); page=1; renderLit(); }};

// æœç´¢æ¡†
$('#search').oninput=e=>{searchTxt=e.target.value.trim().toLowerCase();};
$('#search').addEventListener('keydown',e=>{ if(e.key==='Enter'){ page=1; renderLit(); }});
$('#search-current').onclick=()=>{page=1; renderLit();};
$('#search-global').onclick=()=>{page=1; renderLit(true);};
$('#clear-lit-filter').onclick = ()=>{
  // 1) é‡ç½®æ‰€æœ‰å†…å­˜çŠ¶æ€
  tagFilters.length      = 0;
  litFilterIDs.length    = 0;
  authorFilter           = 'å…¨éƒ¨';
  importanceFilter       = 'å…¨éƒ¨';
  readFilter             = 'å…¨éƒ¨';
  curFolder              = 'å…¨éƒ¨';
  searchTxt              = '';
  $('#search').value     = '';

  // 2) é‡ç»˜ UI
  page = 1;
  buildTagPanel();       // ä¾§æ æ ‡ç­¾é«˜äº®å¤ä½
  buildSearchTags();     // ä¸‰å½©è‰²æ å¤ä½
  refreshFilters();      // å³ä¾§æ”¶è—å¤¹ä¸‹æ‹‰å¤ä½
  renderLit();           // é‡æ–°æ¸²æŸ“åˆ—è¡¨
};


/*************************
 * åˆå§‹åŒ–
 *************************/
refreshDatalists();
refreshFilters();
buildTagPanel();
buildSearchTags();
renderLit();
</script>
</body>
</html>
